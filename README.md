# DocAgent

### Usage

```bash
1. git clone https://github.com/kartashoffv/DocAgent
2. cd DocAgent
3. # закинуть в deployments/.env файл по примеру .env.example
4. docker compose -f ./deployments/docker-compose.dev.yml up --build
# по дефолту бэк крутится на http://localhost:8000, streamlit на http://localhost:8501
# решение работает на api open ai (если ip РФ, необходимо использовать прокси/vpn) 
```

### Описание решения

ИИ-Агент строится на архитектуре FSM (Finite State Machine, по факту модель, которая описывает систему с точки зрения состояний и переходов между этими состояниями.) + Structured Output.

В решении FSM представлено следующим образром: 

**1: Intent Recognition**
- определяет тип запроса пользователя
- Состояния: `offtop` | `fill_attorney_power`
- offtop - модуль обычной болталки
- fill_attorney_power - состояние для заполнения доверенности
- Использует структурированный вывод для классификации намерений (либо часть связанная с заполнением доверенности, либо оффтоп)

**2: Обработка данных внутри состояния fill_attorney_power**
- Состояние, в котором производится анализ пользовательского запроса 
- Состояния: `skip` | `update_field`
- В рамках состояния используются инструменты для отслеживания заполненности объекта доверенности через `get_missing_fields()` и `get_filled_fields()` - получаем информацию о том, какие значения есть, а какие нужно запросить
- skip - если мы не можем извлечь необходимые категории из запроса, просто уточняем, какие значения на заполнения нам нужны
- update_field - когда пользователь указывает новые данные для заполнения или просит обновить текущие.

После заполнения документа на 100% при попадании в update_field будет возвращаться заполненный финальный документ.

В части Structured Output: решение использует Pydantic-схемы для валидации и структурирования ответов со стороны LLM:
- `UserIntent` - классификация намерений
- `PowerOfAttorneyAction` - действия по обработке данных  
- `PowerOfAttorneyData` - структура данных доверенности
- `AgentAnswer` - структурированные ответы пользователю



### Пример даннных для заполнения

```txt
мое ФИО -  Петров Александр Николаевич
живу по адресу г. Москва, ул. Ленинградский проспект, д. 78, кв. 156
паспорт - 4513 768923
выдан ОУФМС России по Московской области в г. Королёв


ФИО поверенного: Смирнова Елена Владимировна
Адрес поверенного: г. Москва, ул. Тверская, д. 15, кв. 42
Серия и номер паспорта поверенного: 4612 852741
Кем выдан - ОУФМС России по г. Москве в районе Арбат


Год выпуска автомобиля: 2019
Номер двигателя: K4M694352
Номер шасси: 94352
Номер кузова: XTA210230K1234567
VIN номер: XTA210230K1234567
регистрационный номер автомобиля: В123КР777

по документам и срокам:
Дата: 15 декабря 2024 г.
Кем выдано свидетельство о регистрации: ГИБДД УМВД России по г. Москве
Орган выдачи свидетельства: РЭО ГИБДД № 3 ЮВАО г. Москвы
Серия и номер ПТС: 77 УН 458932
Срок действия доверенности: до 15 декабря 2025 г.
```



### TODO
- [ ] Оптимизация промптов на всех уровнях
- [ ] Сохранение состояний документа в отдельных чатах
- [ ] Добавить генерацию  PDF с правильным форматированием